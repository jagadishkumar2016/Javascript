var fs = require('fs');
var config = require('../data/config');

var _uname;
var _password;
var _user = {};


module.exports = 
{
    setUserName : function(userName){
        _uname = userName;
    },
    setNewUser : function(user){
        _user = user;
    },
    setPasswpord : function(password){
        _password = password;
    },
    authenticateUser: function(){
        var userDataOBJ = getUsersJSON();
        var respCodes = getCodesJSON();
        for(var i=0;i<userDataOBJ.length;i++)
        {
            if(userDataOBJ[i].uname == _uname)
            {
                if(userDataOBJ[i].password == _password)
                {
                    var resp = respCodes.accepted;
                    resp.name = userDataOBJ[i].name;
                    resp.uname = userDataOBJ[i].uname;
                    resp.password = userDataOBJ[i].password;
                    resp.email = userDataOBJ[i].email;
                    resp.address = userDataOBJ[i].address;
                    resp.phone = userDataOBJ[i].phone;
                    return respCodes.accepted;
                }
            }
        }
        return respCodes.unauthorized;
    },
    registerNewUser : function(){
        appendRawJSON("users.json",_user);
        var respCodes = getCodesJSON();
        return respCodes.created;
    },
    validateUser : function(){
        var userDataOBJ = getUsersJSON();
        var respCodes = getCodesJSON();
        for(var i=0;i<userDataOBJ.length;i++)
        {
            if(userDataOBJ[i].uname == _uname)
            {
                var response = respCodes.conflict;
                return response;
            }
        }
        var response = respCodes.not_found;
        return response;
    },
    listUsers : function(){
        var userDataOBJ = getUsersJSON();
        var userList  = [];
        for(var i=0;i<userDataOBJ.length;i++)
        {
            var user = {
                name: userDataOBJ[i].name,
                uname:userDataOBJ[i].uname
                } 
            userList[userList.length] = user;
        }
        return JSON.stringify(userDataOBJ);
    },
    getUserDetailsForUserId : function(){
        var userDataOBJ = getUsersJSON();
        var respCodes = getCodesJSON();
        var user = null;
        for(var i=0;i<userDataOBJ.length;i++)
        {
            if(userDataOBJ[i].uname == _uname)
            {
                user = 
                {
                    name : userDataOBJ[i].name,
                    uname : userDataOBJ[i].uname,
                    address : userDataOBJ[i].address,
                    phone : userDataOBJ[i].phone,
                    email : userDataOBJ[i].email,
                    ordercount : userDataOBJ[i].ordercount
                }
                return user;
            }
        }
        return respCodes.not_found;
    }
};



function appendRawJSON(fileName,newOBJ)
{
    var jsonOBJ = getUsersJSON();
    jsonOBJ.push(newOBJ);
    fs.writeFileSync(config.dataFolderPath + '/'+fileName,JSON.stringify(jsonOBJ));
}


function getUsersJSON()
{
    var stringIn = fs.readFileSync(config.dataFolderPath + '/users.json',"utf8").trim();
    var jsonOBJ = JSON.parse(stringIn);
    if(jsonOBJ.length != 0)
    {
        return jsonOBJ;
    }
    var user = {
        name: "admin",
        email: "admin@123.com",
        password: "123admin",
        phone : "123456789",
        address : "somewhere",
        uname : "i.am.admin",
        ordercount:"999"
    };
    jsonOBJ.push(user);
    return jsonOBJ;
}

function getCodesJSON()
{
    var stringIn = fs.readFileSync(config.dataFolderPath + '/codes.json',"utf8").trim();
    return JSON.parse(stringIn);
}