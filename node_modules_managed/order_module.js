var fs = require('fs');
var config = require('../data/config');

var _order,_user,_processedOrder;

module.exports = 
{
    setSessionUser : function(user)
    {
        _user = user;
    },
    setCurrentOrder : function(order){
        _order = order;
    },
    generateOrderReciptForUser: function(){
        var date = new Date();
        var resp = getCodesJSON();
        _processedOrder = {
        orderNumber : _user.id,
        orderDate: date,
        orderDelivered: false,
        orderItems: _order
        }
        processOrderForCurrentUser();
        return resp.ok; 
    }
};


function processOrderForCurrentUser()
{
    var foundUser = false;
    var orderDB = getOrdersJSON();
    if(!orderDB)
    {
        orderDB = createDB();
    }
    for(var i= 0;i<orderDB.length;i++)
    {
        if(orderDB[i].uname == _user.uname)
        {
            foundUser = true;
            orderDB[i].orders.push(_processedOrder);
            break;
        }
    }
    if(!foundUser)
    {
        var newUserTemplate =  {
            uname : _user.uname,
            orders : [ _processedOrder
            ]
        }
        orderDB.push(newUserTemplate);
    }
    appendOrdersJSON("orders.json",orderDB);
}


function createDB()
{
  var orderTemplate = []
  return JSON.parse(JSON.stringify(orderTemplate));  
}


function appendOrdersJSON(fileName,newOBJ)
{
    fs.writeFileSync(config.dataFolderPath + '/'+fileName,JSON.stringify(newOBJ));
}

function getOrdersJSON(){
    var stringIn = fs.readFileSync(config.dataFolderPath + '/orders.json',"utf8").trim();
    if(stringIn == "")
    {
        return null;
    }
    var jsonOBJ = JSON.parse(stringIn);
    return jsonOBJ;
}

function getUsersJSON()
{
    var stringIn = fs.readFileSync(config.dataFolderPath + '/users.json',"utf8").trim();
    var jsonOBJ = JSON.parse(stringIn);
    if(jsonOBJ.length != 0)
    {
        return jsonOBJ;
    }
    var user = {
        name: "admin",
        email: "admin@123.com",
        password: "123admin",
        phone : "123456789",
        address : "somewhere",
        uname : "i.am.admin",
        ordercount:"999"
    };
    jsonOBJ.push(user);
    return jsonOBJ;
}

function getCodesJSON()
{
    var stringIn = fs.readFileSync(config.dataFolderPath + '/codes.json',"utf8").trim();
    return JSON.parse(stringIn);
}