var fs = require('fs');
var config = require('../data/config');
var codes = require('../data/codes');
var codes = require('../data/users');

var _foodItem;
var _user;



module.exports = 
{
    setNewFoodItem : function(foodItem){
        _foodItem = foodItem;
    },
    addNewFoodItem : function(){
        var codes = getCodesJSON();
        var food = getFoodJSON();
        var theFood = {
            name: _foodItem.name,
            type: _foodItem.type,
            availablity: _foodItem.availablity,
            cost: _foodItem.cost,
            description: _foodItem.description,
            imagePath: _foodItem.imagePath
        }
        food[_foodItem.category].push(theFood);
        appendRawJSON("food.json",food);
        return codes.created;
    },
    getUserListing : function(){
        var users = getUsersJSON();
        var temp = [];
        for(var i=0;i<users.length;i++)
        {
            var newObj = {
                name:users[i].name,
                email:users[i].email,
                phone:users[i].phone,
                address:users[i].address,
                uname:users[i].uname,
                ordercount:users[i].ordercount
            }
            temp.push(newObj);
        }
        return temp;
    },
    getOrderListing : function(){
        var orders = getOrderJSON();
        return orders;
    },
    setUser : function(user){
        _user = user;
    },
    setOrderForUser : function(order){
        _order = order;
        _user = user;
    },
    changeOrderStatusForUser : function(){
        var codes = getCodesJSON();
        var orders = getOrderJSON();
        var done = false;
        for(var i=0;i<orders.length;i++)
        {
            if(!done)
            {
                if(orders[i].uname = _user.uname)
                {
                    for(var j=0;j<orders[i].length;j++)
                    {
                        if(orders[i][j].orderNumber == _order.orderNumber)
                        {
                            orders[i][j] = _order;
                            done = true;
                            break;
                        }
                    }
                }
            }
            
        }
    },
    getAllOrdersForUser : function(){
        var orderDB = getOrdersJSON();
        for(var i = 0;i<orderDB.length;i++)
        {
            if(orderDB[i].uname == _user.uname)
            {
                return orderDB[i].orders;
            }
        }
        return resp.not_found;
    },
    setUserName : function (uname){
        _uname = uname;
    },
    getUserDetailsForUserId : function(){
        var userDataOBJ = getUsersJSON();
        var respCodes = getCodesJSON();
        var user = null;
        for(var i=0;i<userDataOBJ.length;i++)
        {
            if(userDataOBJ[i].uname == _uname)
            {
                user = 
                {
                    name : userDataOBJ[i].name,
                    uname : userDataOBJ[i].uname,
                    address : userDataOBJ[i].address,
                    phone : userDataOBJ[i].phone,
                    email : userDataOBJ[i].email,
                    ordercount : userDataOBJ[i].ordercount
                }
                return user;
            }
        }
        return respCodes.not_found;
    }
};



function appendRawJSON(fileName,newOBJ)
{
    fs.writeFileSync(config.dataFolderPath + '/'+fileName,JSON.stringify(newOBJ));
}

function getFoodJSON(){
    var stringIn = fs.readFileSync(config.dataFolderPath + '/food.json',"utf8").trim();
    var jsonOBJ = JSON.parse(stringIn);
    return jsonOBJ;
}

function getOrderJSON(){
    var stringIn = fs.readFileSync(config.dataFolderPath + '/orders.json',"utf8").trim();
    var jsonOBJ = JSON.parse(stringIn);
    return jsonOBJ;
}


function getUsersJSON()
{
    var stringIn = fs.readFileSync(config.dataFolderPath + '/users.json',"utf8").trim();
    var jsonOBJ = JSON.parse(stringIn);
    if(jsonOBJ.length != 0)
    {
        return jsonOBJ;
    }
    var user = {
        name: "admin",
        email: "admin@123.com",
        password: "123admin",
        phone : "123456789",
        address : "somewhere",
        uname : "i.am.admin",
        ordercount:"999"
    };
    jsonOBJ.push(user);
    return jsonOBJ;
}

function getCodesJSON()
{
    var stringIn = fs.readFileSync(config.dataFolderPath + '/codes.json',"utf8").trim();
    return JSON.parse(stringIn);
}